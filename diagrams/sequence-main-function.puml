@startuml Sequence_Main_Function

title Sequence Diagram - Core Function\nPhÆ°Æ¡ng Thá»©c Hoáº¡t Äá»™ng ChÃ­nh: Cáº­p Nháº­t Doanh Thu Tá»« ÄÆ¡n HÃ ng\n(LiÃªn káº¿t 4 Ä‘á»‘i tÆ°á»£ng: KhachHang, SanPham, DonHang, DoanhThu)

actor "KhÃ¡ch HÃ ng" as User
participant "Web UI" as UI
participant "DonHangController" as DHC
participant "DonHangService" as DHS
participant "KhachHangService" as KHS
participant "SanPhamService" as SPS
participant "DoanhThuService" as DTS
participant "DonHangRepository" as DHR
participant "SanPhamRepository" as SPR
participant "DoanhThuRepository" as DTR
database "MySQL Database" as DB

== BÆ¯á»šC 1: KhÃ¡ch HÃ ng Äáº·t HÃ ng ==
User -> UI: Click "Äáº·t hÃ ng"\nChá»n sáº£n pháº©m, nháº­p sá»‘ lÆ°á»£ng
activate UI
UI -> DHC: POST /api/donhang/tao\n{khachHangId: 1, sanPhamId: 5, soLuong: 3}
activate DHC

DHC -> DHS: taoDonHang(1, 5, 3)
activate DHS

note over DHS
  <b>Validate Ä‘Æ¡n hÃ ng</b>
  - Kiá»ƒm tra khÃ¡ch hÃ ng tá»“n táº¡i
  - Kiá»ƒm tra sáº£n pháº©m tá»“n táº¡i
  - Kiá»ƒm tra sá»‘ lÆ°á»£ng há»£p lá»‡
end note

DHS -> KHS: timKhachHangTheoId(1)
activate KHS
KHS --> DHS: KhachHang\n{id:1, ten:"Nguyá»…n VÄƒn A", sdt:"0901234567"}
deactivate KHS

DHS -> SPS: timSanPhamTheoId(5)
activate SPS
SPS -> SPR: findById(5)
activate SPR
SPR -> DB: SELECT * FROM san_pham WHERE id = 5
activate DB
DB --> SPR: SanPham
deactivate DB
SPR --> SPS: SanPham\n{id:5, ten:"NÆ°á»›c MÃ­a", donGia:15000, tonKho:50}
deactivate SPR
deactivate SPS

DHS -> DHS: Kiá»ƒm tra tá»“n kho\nconHang() && duSoLuong(3)\n50 >= 3 â†’ OK

DHS -> DHS: Táº¡o DonHang\n- maDonHang = "DH" + timestamp\n- tongTien = 15000 * 3 = 45000\n- trangThai = "Äang xá»­ lÃ½"

DHS -> DHR: save(donHang)
activate DHR
DHR -> DB: INSERT INTO don_hang\nVALUES (ma_don_hang, khach_hang_id, san_pham_id,\nso_luong, tong_tien, trang_thai, ngay_dat)
activate DB
DB --> DHR: DonHang saved {id: 100}
deactivate DB
DHR --> DHS: DonHang
deactivate DHR

== BÆ¯á»šC 2: Giáº£m Tá»“n Kho ==
DHS -> SPS: capNhatTonKho(5, -3)
activate SPS

note right of SPS
  <b>Cáº­p nháº­t tá»“n kho</b>
  tonKho = 50 - 3 = 47
end note

SPS -> SPR: save(sanPham)
activate SPR
SPR -> DB: UPDATE san_pham\nSET so_luong_ton_kho = 47\nWHERE id = 5
activate DB
DB --> SPR: SanPham updated
deactivate DB
SPR --> SPS: SanPham {tonKho: 47}
deactivate SPR
deactivate SPS

DHS --> DHC: DonHang created\n{id:100, maDonHang:"DH1730901234567"}
deactivate DHS
DHC --> UI: 201 Created
deactivate DHC
UI --> User: âœ… "Äáº·t hÃ ng thÃ nh cÃ´ng!\nMÃ£ Ä‘Æ¡n: DH1730901234567"
deactivate UI

== BÆ¯á»šC 3: XÃ¡c Nháº­n HoÃ n ThÃ nh ÄÆ¡n HÃ ng ==
User -> UI: Click "XÃ¡c nháº­n hoÃ n thÃ nh"
activate UI
UI -> DHC: PATCH /api/donhang/100/hoan-thanh
activate DHC

DHC -> DHS: hoanThanhDonHang(100)
activate DHS

DHS -> DHR: findById(100)
activate DHR
DHR -> DB: SELECT * FROM don_hang WHERE id = 100
activate DB
DB --> DHR: DonHang
deactivate DB
DHR --> DHS: DonHang {trangThai: "Äang xá»­ lÃ½"}
deactivate DHR

DHS -> DHS: setTrangThai("ÄÃ£ hoÃ n thÃ nh")

DHS -> DHR: save(donHang)
activate DHR
DHR -> DB: UPDATE don_hang\nSET trang_thai = 'ÄÃ£ hoÃ n thÃ nh'\nWHERE id = 100
activate DB
DB --> DHR: DonHang updated
deactivate DB
DHR --> DHS: DonHang {trangThai: "ÄÃ£ hoÃ n thÃ nh"}
deactivate DHR

== BÆ¯á»šC 4: Cáº¬P NHáº¬T DOANH THU (CORE FUNCTION) ==

note over DHS, DTS
  <b>ğŸ¯ PHÆ¯Æ NG THá»¨C HOáº T Äá»˜NG CHÃNH</b>
  Tá»± Ä‘á»™ng cáº­p nháº­t doanh thu khi Ä‘Æ¡n hÃ ng hoÃ n thÃ nh
  LiÃªn káº¿t táº¥t cáº£ 4 Ä‘á»‘i tÆ°á»£ng:
  KhachHang â†’ DonHang â†’ SanPham â†’ DoanhThu
end note

DHS -> DTS: capNhatDoanhThuTuDonHang(donHang)
activate DTS

DTS -> DTS: Validate\ndaHoanThanh() == true âœ“

DTS -> DTS: Láº¥y ngÃ y Ä‘Æ¡n hÃ ng\nngayDonHang = donHang.getNgayDat().toLocalDate()

DTS -> DTR: existsByNgayGhiNhan(ngayDonHang)
activate DTR
DTR -> DB: SELECT COUNT(*) FROM doanh_thu\nWHERE ngay_ghi_nhan = ?
activate DB
DB --> DTR: true (Ä‘Ã£ cÃ³ bÃ¡o cÃ¡o)
deactivate DB
DTR --> DTS: true
deactivate DTR

DTS -> DTS: layDoanhThuTheoNgay(ngayDonHang)
DTS -> DTR: findByNgayGhiNhan(ngayDonHang)
activate DTR
DTR -> DB: SELECT * FROM doanh_thu\nWHERE ngay_ghi_nhan = ?
activate DB
DB --> DTR: DoanhThu\n{tongTien: 2000000, soDonHang: 45, soKhachHang: 30}
deactivate DB
DTR --> DTS: DoanhThu hiá»‡n táº¡i
deactivate DTR

note over DTS
  <b>Cáº­p nháº­t doanh thu tá»« Ä‘Æ¡n hÃ ng</b>
  - tongTien: 2000000 + 45000 = 2045000
  - soDonHang: 45 + 1 = 46
  - thoiGianCapNhat = LocalDateTime.now()
end note

DTS -> DTS: capNhatDoanhThuTuDonHang(donHang)\n- doanhThu.tongTien += 45000\n- doanhThu.soDonHang++

DTS -> DTR: save(doanhThu)
activate DTR
DTR -> DB: UPDATE doanh_thu\nSET tong_tien = 2045000,\n    so_don_hang = 46,\n    thoi_gian_cap_nhat = NOW()\nWHERE id = ?
activate DB
DB --> DTR: DoanhThu updated
deactivate DB
DTR --> DTS: DoanhThu\n{tongTien: 2045000, soDonHang: 46}
deactivate DTR

DTS --> DHS: DoanhThu updated âœ…
deactivate DTS

DHS --> DHC: DonHang hoÃ n thÃ nh + DoanhThu cáº­p nháº­t
deactivate DHS
DHC --> UI: 200 OK
deactivate DHC

UI --> User: âœ… "ÄÆ¡n hÃ ng Ä‘Ã£ hoÃ n thÃ nh!\nDoanh thu Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t"
deactivate UI

== BÆ¯á»šC 5: Xem BÃ¡o CÃ¡o Doanh Thu ==
User -> UI: Click "Xem doanh thu hÃ´m nay"
activate UI
UI -> DHC: GET /api/doanhthu/hom-nay
activate DHC

DHC -> DTS: layDoanhThuHomNay()
activate DTS

DTS -> DTR: layDoanhThuHomNay()
activate DTR
DTR -> DB: SELECT * FROM doanh_thu\nWHERE ngay_ghi_nhan = CURRENT_DATE
activate DB
DB --> DTR: DoanhThu
deactivate DB
DTR --> DTS: DoanhThu {tongTien: 2045000, soDonHang: 46}
deactivate DTR

DTS --> DHC: DoanhThu hÃ´m nay
deactivate DTS
DHC --> UI: 200 OK
deactivate DHC

UI --> User: ğŸ“Š Hiá»ƒn thá»‹ bÃ¡o cÃ¡o:\n"Doanh thu hÃ´m nay: 2,045,000 VNÄ\nSá»‘ Ä‘Æ¡n hÃ ng: 46 Ä‘Æ¡n"
deactivate UI

note over User, DB
  <b>âœ… HOÃ€N Táº¤T LUá»’NG HOáº T Äá»˜NG CHÃNH</b>
  
  Káº¿t quáº£:
  1. âœ… KhÃ¡ch hÃ ng Ä‘áº·t hÃ ng thÃ nh cÃ´ng
  2. âœ… Tá»“n kho sáº£n pháº©m Ä‘Æ°á»£c cáº­p nháº­t (50 â†’ 47)
  3. âœ… ÄÆ¡n hÃ ng Ä‘Æ°á»£c táº¡o vÃ  hoÃ n thÃ nh
  4. âœ… Doanh thu Ä‘Æ°á»£c cáº­p nháº­t tá»± Ä‘á»™ng (2,000,000 â†’ 2,045,000)
  
  <b>4 Äá»‘i tÆ°á»£ng liÃªn káº¿t:</b>
  â€¢ KhachHang: NgÆ°á»i Ä‘áº·t hÃ ng
  â€¢ SanPham: Sáº£n pháº©m Ä‘Æ°á»£c Ä‘áº·t
  â€¢ DonHang: Giao dá»‹ch mua bÃ¡n
  â€¢ DoanhThu: Tá»•ng há»£p káº¿t quáº£ kinh doanh
end note

@enduml
